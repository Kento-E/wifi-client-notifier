name: Auto Merge on Approval

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.review.state == 'approved'
    
    steps:
      - name: PRæƒ…å ±ã‚’è¡¨ç¤º
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BASE: ${{ github.event.pull_request.base.ref }}
          PR_HEAD: ${{ github.event.pull_request.head.ref }}
          REVIEWER: ${{ github.event.review.user.login }}
        run: |
          echo "PR #${{ github.event.pull_request.number }}: ${PR_TITLE}"
          echo "Base: ${PR_BASE}"
          echo "Head: ${PR_HEAD}"
          echo "Reviewer: ${REVIEWER}"

      - name: è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œ
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "PR #${PR_NUMBER} ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸã€‚è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’é–‹å§‹ã—ã¾ã™..."
          
          # PRãŒDraftã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
          IS_DRAFT=$(gh pr view ${PR_NUMBER} --repo ${{ github.repository }} --json isDraft --jq '.isDraft')
          
          if [ "$IS_DRAFT" = "true" ]; then
            echo "âš ï¸ ã“ã®PRã¯DraftçŠ¶æ…‹ã§ã™ã€‚DraftçŠ¶æ…‹ã®PRã¯è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã›ã‚“ã€‚"
            echo "Ready for reviewã«å¤‰æ›´ã—ã¦ã‹ã‚‰å†åº¦Approveã—ã¦ãã ã•ã„ã€‚"
            exit 0
          fi
          
          # PRã®ãƒãƒ¼ã‚¸å¯èƒ½çŠ¶æ…‹ã‚’ç¢ºèª
          echo "ğŸ“‹ PRçŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
          gh pr view ${PR_NUMBER} --repo ${{ github.repository }} --json mergeable,mergeStateStatus --jq '.mergeable,.mergeStateStatus'
          
          # è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’æœ‰åŠ¹åŒ–ï¼ˆã‚¹ã‚«ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ã€ãƒ–ãƒ©ãƒ³ãƒå‰Šé™¤ï¼‰
          echo "ğŸ”„ è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’è¨­å®šä¸­..."
          gh pr merge ${PR_NUMBER} --repo ${{ github.repository }} --squash --auto --delete-branch
          
          echo "âœ… PR #${PR_NUMBER} ã®è‡ªå‹•ãƒãƒ¼ã‚¸ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ"
          echo ""
          echo "ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
          echo "  1. ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ã§è¦æ±‚ã•ã‚Œã‚‹æ‰¿èªã‚’å–å¾—"
          echo "  2. ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸ"
          echo "  3. â†’ è‡ªå‹•çš„ã«Squash and MergeãŒå®Ÿè¡Œã•ã‚Œã¾ã™"
          echo "  4. ãƒãƒ¼ã‚¸å¾Œã€ãƒ–ãƒ©ãƒ³ãƒãŒè‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™"
